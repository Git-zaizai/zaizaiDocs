# æ•°æ®ç±»å‹çš„æ‹·è´

åœ¨[ä¸Šä¸€ç¯‡æ–‡ç« ä¸­](./æ•°æ®ç±»å‹.md)è®²è¿°äº† JS çš„æ•°æ®ç±»å‹ï¼Œ

è€Œåœ¨ JS ä¸­åˆ`ä¸€åˆ‡çš†å¯¹è±¡`ä¸­ï¼Œæˆ‘ä»¬æ›¾ç»æ¸…æ™°åœ°è¡¨è¾¾ä¸€ä¸ªè§‚ç‚¹ï¼Œ

åœ¨ JavaScript çš„ä¸–ç•Œé‡Œï¼Œé™¤å» undefinedã€null å¤–ï¼Œ`ä¸€åˆ‡çš†å¯¹è±¡`ã€‚

å¯¹è±¡åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é¢‘ç¹ç”¨åˆ°çš„ä¸€ç‚¹æ˜¯èµ‹å€¼æ‹·è´ï¼Œè€Œå½“ä½ æ‹·è´å‡ºé”™æ—¶ï¼Œæƒ…å†µä¼šå¾ˆç³Ÿç³•ã€‚æ‰€ä»¥æˆ‘ä»¬è¿™èŠ‚å°±æ˜¯ä¸ºè®²è§£æ•°æ®ä¸­çš„æ‹·è´è€Œç”Ÿã€‚

é¦–å…ˆ JavaScript æ²¡æœ‰`ä¸å¯å˜æ•°æ®ç»“æ„`ï¼Œ`ä¸å¯å˜æ•°æ®ç»“æ„`æ˜¯å‡½æ•°å¼ç¼–ç¨‹ä¸­å¿…å¤‡çš„

å¯å˜çš„å¥½å¤„æ˜¯èŠ‚çœå†…å­˜æˆ–æ˜¯åˆ©ç”¨å¯å˜æ€§åšä¸€äº›äº‹æƒ…ï¼Œä½†æ˜¯åœ¨å¤æ‚çš„å¼€å‘ä¸­å®ƒçš„å‰¯ä½œç”¨è¿œæ¯”å¥½å¤„å¤§å¾—å¤šï¼Œ

äºæ˜¯æœ‰äº†`æµ…æ‹·è´`å’Œ`æ·±æ‹·è´`ï¼Œè¯´å¾—ç›´ç™½ç‚¹ï¼Œæµ…æ‹·è´åªæ‹·è´ä¸€å±‚ï¼Œæ·±æ‹·è´ç›´æ¥å¤åˆ¶å¯¹è±¡
ä¸ºä»€ä¹ˆè¦æœ‰æµ…æ‹·è´ï¼Œç›´æ¥æ·±æ‹·è´ä»£æ›¿ä¸å°±å¥½äº†ã€‚

å½“ç„¶ï¼Œè¿™ä¸ªé—®é¢˜åŒæ ·æœ‰ç½‘å‹æå‡ºâ€”â€”JS çš„æµ…æ‹·è´ç©¶ç«Ÿæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿï¼Œ

è™½ç„¶ç¬”è€…æ²¡æ‰¾åˆ°ç›¸å…³èµ„æ–™ï¼Œä½†æ€€ç–‘è¿˜æ˜¯å› ä¸ºæ€§èƒ½ï¼Œæµ…æ‹·è´èƒ½åº”ä»˜å¾ˆå¤šåœºæ™¯ï¼Œ

éä¸å¿…è¦ä¸ç”¨æ·±æ‹·è´ã€‚åœ¨è®¾è®¡ä¸Šè®©å¼€å‘è€…å°‘ç”¨ï¼Œæ— å½¢ä¸­æé«˜å¼€å‘ä½“éªŒ

## åŸºç¡€ç±»å‹çš„æ‹·è´

å¯¹äºåŸºç¡€ç±»å‹çš„æ‹·è´ç›´æ¥å£°æ˜ä¸€ä¸ªå˜é‡èµ‹å€¼å³å¯

```js
var a = 'str'
var b = a
a = 'spon'
console.log(a, b) // spon  str
```

åœ¨æ­¤ä¸¾ä¾‹ä¸€ä¸ªå­—ç¬¦ä¸²çš„æ‹·è´ï¼Œå¯¹äºå…¶ä»–ç±»å‹ä¹Ÿæ˜¯ä¸€æ ·çš„èµ‹å€¼å°±æ˜¯ä¸€ä¸ªæ–°çš„ä¸œè¥¿

## å¼•ç”¨ç±»å‹çš„æ‹·è´

> TIPï¼šä»¥å¼•ç”¨ç±»å‹ä¸­çš„å¯¹è±¡ä¸ºä»£è¡¨ä¸¾ ğŸŒ°

## æµ…æ‹·è´ [â€‹](#æµ…æ‹·è´)

![æµ…æ‹·è´](https://notes.fe-mm.com/assets/clone.4bdb028e.webp)

> å›¾ç‰‡æ¥æºäº[å¦‚ä½•å†™å‡ºä¸€ä¸ªæƒŠè‰³é¢è¯•å®˜çš„æ·±æ‹·è´?](https://juejin.cn/post/6844903929705136141)

æµ…æ‹·è´æ˜¯åˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æœ‰ç€åŸå§‹å¯¹è±¡å±æ€§å€¼çš„ä¸€ä»½ç²¾ç¡®æ‹·è´ï¼šåŸºæœ¬ç±»å‹æ‹·è´çš„æ˜¯å€¼ï¼Œå¼•ç”¨ç±»å‹æ‹·è´çš„å°±æ˜¯å†…å­˜åœ°å€ï¼›æ‰€ä»¥å½“æˆ‘ä»¬**æ“ä½œæ–°å¯¹è±¡ä¸­çš„å¼•ç”¨ç±»å‹æ—¶ä¼šå½±å“æºå¯¹è±¡**

### Object.assign() [â€‹](#object-assign)

```js
const obj1 = {
  name: 'maomao',
  props: { a: 1 }
}

const obj2 = Object.assign({}, obj1)
obj2.name = 'èŒ‚èŒ‚'
obj2.props.a++

obj1 // { name: 'maomao', props: { a: 2 } }
obj2 // { name: 'èŒ‚èŒ‚', props: { a: 2 } }
```

### `Array.prototype.concat()` [â€‹](#array-prototype-concat)

```js
const arr1 = [1, 2, 3, [4, 5]]

const arr2 = arr1.concat()
arr2[0] = 'arr2'
arr2[3][0] = 'arr2'

arr1 // [1, 2, 3, ['arr2', 5]];
arr2 // ['arr2', 2, 3, ['arr2', 5]];
```

### `Array.prototype.slice()` [â€‹](#array-prototype-slice)

```js
const arr1 = [1, 2, 3, [4, 5]]

const arr2 = arr1.slice()
arr2[0] = 'arr2'
arr2[3][0] = 'arr2'

arr1 // [1, 2, 3, ['arr2', 5]];
arr2 // ['arr2', 2, 3, ['arr2', 5]];
```

### `ES6` æ‰©å±•è¿ç®—ç¬¦ [â€‹](#es6-æ‰©å±•è¿ç®—ç¬¦)

```js
/* å¯¹è±¡ */
const obj1 = {
  name: 'maomao',
  props: { a: 1 }
}

const obj2 = { ...obj1 }
obj2.name = 'èŒ‚èŒ‚'
obj2.props.a++

obj1 // { name: 'maomao', props: { a: 2 } }
obj2 // { name: 'èŒ‚èŒ‚', props: { a: 2 } }

/* æ•°ç»„ */
const arr1 = [1, 2, 3, [4, 5]]

const arr2 = [...arr1]
arr2[0] = 'arr2'
arr2[3][0] = 'arr2'

arr1 // [1, 2, 3, ['arr2', 5]];
arr2 // ['arr2', 2, 3, ['arr2', 5]];
```

## æ·±æ‹·è´

![æ·±æ‹·è´](https://notes.fe-mm.com/assets/clone-deep.34f5791e.webp)

æ·±æ‹·è´æ˜¯å°†ä¸€ä¸ªå¯¹è±¡ä»å†…å­˜ä¸­å®Œæ•´çš„æ‹·è´ä¸€ä»½å‡ºæ¥ï¼Œå³ä»å †å†…å­˜ä¸­å¼€è¾Ÿä¸€ä¸ªæ–°çš„åŒºåŸŸå­˜æ”¾æ–°å¯¹è±¡ï¼Œæ‰€ä»¥**ä¿®æ”¹æ–°å¯¹è±¡ä¸ä¼šå½±å“åŸå¯¹è±¡**ï¼Œ
ç›®å‰æ— éå°±ä¸‰ç§æ–¹å¼æ¥å®ç°æ·±æ‹·è´ï¼Œ`JSONè½¬æ¢`ï¼Œ`Web API`ï¼Œ`é€’å½’å‡½æ•°`è¿™ä¸‰ç§æ–¹å¼ã€‚

### `JSON.parse(JSON.stringify())`

```js
const obj1 = {
  name: 'maomao',
  props: { a: 1 }
}

const obj2 = JSON.parse(JSON.stringify(obj1))
obj2.name = 'èŒ‚èŒ‚'
obj2.props.a++

obj1 // { name: 'maomao', props: { a: 1 } }
obj2 // { name: 'èŒ‚èŒ‚', props: { a: 2 } }
```

**`JSON.parse(JSON.stringify())` å­˜åœ¨æ˜æ˜¾çš„å¼Šç«¯ï¼š**

- åªèƒ½åºåˆ—åŒ–å¯¹è±¡çš„å¯æšä¸¾çš„è‡ªæœ‰å±æ€§
- `undefined`ã€`Symbol`ã€ä»»æ„å‡½æ•°å°†è¢«å¿½ç•¥
- `NaN`ã€`Infinity` ã€`-Infinity` å°†è¢«å½“æˆ `null` å¤„ç†
- `RegExp`ã€`Error`ã€`Set`ã€`Map` ç­‰ç‰¹æ®Šå¯¹è±¡ï¼Œä»…ä¼šåºåˆ—åŒ–å¯æšä¸¾çš„å±æ€§ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹å³ä¸ºç©ºå¯¹è±¡ï¼‰
- `Date` ç±»å‹ï¼Œè½¬æ¢åä¼šè°ƒç”¨ `toJSON` è½¬ä¸ºå­—ç¬¦ä¸²ç±»å‹
- å¾ªç¯å¼•ç”¨çš„å¯¹è±¡å°†æŠ¥é”™

```js
const map = new Map()
map.set(1, 2) // Map: 0: {1 => 2}
const obj1 = {
  a: undefined,
  b: null,
  c: Symbol(),
  d: NaN,
  e: Infinity,
  f: -Infinity,
  g: map,
  h: new Date(),
  i: () => {}
}
Object.defineProperty(obj1, 'j', {
  value: 'string'
})

const obj2 = JSON.parse(JSON.stringify(obj1))

/** æºå¯¹è±¡ obj1
{
  a: undefined,
  b: null,
  c: Symbol(),
  d: NaN,
  e: Infinity,
  f: -Infinity,
  g: Map(1)Â {1 => 2}
  h: Fri Mar 10 2023 22:41:08 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) {},
  i: () => {},

  j: 'string'
}
**/

/** æ–°å¯¹è±¡ obj2
{
  b: null,
  d: null,
  e: null,
  f: null,
  g: {},
  h: '2023-03-10T14:41:08.110Z'
}
**/
```

### `structuredClone`

> `HTML` è§„èŒƒæ ‡å‡†çš„ [Web API](https://developer.mozilla.org/zh-CN/docs/Web/API/structuredClone)

```js
const original = { name: 'MDN' }
original.itself = original

const clone = structuredClone(original)

console.assert(clone !== original) // the objects are not the same (not same identity)
console.assert(clone.name === 'MDN') // they do have the same values
console.assert(clone.itself === clone) // and the circular reference is preserved
```

`HTML` è§„èŒƒçš„æ ‡å‡†ææ¡ˆï¼Œä½¿ç”¨ç»“æ„åŒ–å…‹éš†ç®—æ³•å°†ç»™å®šçš„å€¼è¿›è¡Œæ·±æ‹·è´ï¼Œæ”¯æŒå¾ªç¯å¼•ç”¨ã€‚è¿˜å¯ä»¥ä½¿ç”¨ `structuredClone(value, { transfer })` è°ƒç”¨æ–¹å¼ä½¿å¯è½¬ç§»å¯¹è±¡ä»…è¢«ä¼ é€’ï¼Œä¸è¢«å…‹éš†ï¼ˆç›´æ¥ç§»åŠ¨æºæ•°æ®ï¼‰

æ³¨æ„ç‚¹

å°½ç®¡ä½œä¸ºè§„èŒƒæ ‡å‡†å®ç°çš„ `Web API`ï¼Œä½†ç›®å‰å…¼å®¹æ€§è¿˜æ˜¯ä¸ªå·¨å¤§çš„é—®é¢˜ï¼ŒåŒæ—¶ä»æœ‰å…¶ä»–ä¸è¶³ï¼š

- æ— æ³•æ‹·è´å¯¹è±¡çš„åŸå‹é“¾
- æ— æ³•æ‹·è´å‡½æ•°
- ä¸æ”¯æŒ `Error` æ•°æ®ç±»å‹

### `MessageChannel`

> `vue.nextTick` æºç æ›¾ä½¿ç”¨çš„ `Web API`ï¼Œåœ¨äº†è§£è¿™ä¸ª `API` æ—¶å‘ç°å¯ä»¥ç”¨äºæ·±æ‹·è´

```js
function cloneUsingChannel(obj) {
  return new Promise((resolve) => {
    const channel = new MessageChannel()
    channel.port1.onmessage = (e) => resolve(e.data)
    channel.port2.postMessage(obj)
  })
}
```

ä½†è¯¥æ–¹æ³•å­˜åœ¨ä¸€ä¸ªç¼ºé™·ï¼Œå½“æ‹·è´å¯¹è±¡å¸¦æœ‰å‡½æ•°å±æ€§æ—¶ï¼Œå°†æŠ›å‡ºé”™è¯¯ï¼š

```js
const obj1 = {
  fn: function () {}
}
const obj2 = cloneUsingChannel(obj1)
// Uncaught (in promise) DOMException: Failed to execute 'postMessage' on 'MessagePort': function () {} could not be cloned.
```

### deepClone å‡½æ•°é€’å½’æ‹·è´

å‰é¢çš„ä¸‰ç§æ–¹å¼éƒ½ä¸å¯é¿å…çš„æœ‰è¾¹ç•Œé—®é¢˜ï¼Œç›®å‰ä¸»è¦æ–¹æ³•è¿˜æ˜¯ä½¿ç”¨çš„ `å‡½æ•°é€’å½’æ‹·è´`ï¼Œ
å®ƒé¿å¼€äº†å‰é¢ `API` çš„è¾¹ç•Œé—®é¢˜ï¼Œä¹Ÿæ²¡æœ‰å…¼å®¹æ€§çš„é—®é¢˜ï¼ŒåŸç†ï¼š

::: tip
JS æ•°æ®ç±»å‹çš„å­˜å‚¨æœºåˆ¶ï¼ŒåŸºç¡€ç±»å‹çš„æ‹·è´æ˜¯å¤åˆ¶ä¸€ä»½å‡ºæ¥æˆä¸ºä¸€ä»½æ–°çš„æ•°æ®ï¼Œ
å¤šå±‚åµŒå¥—çš„å¼•ç”¨ç±»å‹éƒ½å¯ä»¥æ‹†åˆ†æˆæœ€åŸºç¡€çš„å€¼ç±»å‹çš„èµ‹å€¼æ“ä½œï¼Œ
å¯¹äºç‰¹æ®Šç±»å‹ `Date`ã€`Set`ã€`Map`ã€`function`ç­‰ç­‰ç±»å‹ï¼Œ
é‡æ–°æ–°å»ºä¸€ä»½ï¼Œå°±ä¸ä¼šå¼•å…¥æ—§çš„äº†ã€‚
:::

å®ä¾‹ï¼š

```js
function deepClone(value, weakMap = new WeakMap()) {
  const typeVar = (val) => Object.prototype.toString.call(val)

  const is = {
    Array: Array.isArray,
    Date: (val) => val instanceof Date,
    Set: (val) => typeVar(val) === '[object Set]',
    Map: (val) => typeVar(val) === '[object Map]',
    Object: (val) => typeVar(val) === '[object Object]',
    Symbol: (val) => typeVar(val) === '[object Symbol]',
    Function: (val) => typeVar(val) === '[object Function]'
  }

  // 2.1 å‡½æ•°æµ…æ‹·è´
  /* if (is.Function(value)) return value */

  // 2.2 å‡½æ•°æ·±æ‹·è´
  if (is.Function(value)) {
    if (/^function/.test(value.toString()) || /^\(\)/.test(value.toString()))
      return new Function('return ' + value.toString())()

    return new Function('return function ' + value.toString())()
  }

  // 3.Date æ·±æ‹·è´
  if (is.Date(value)) return new Date(value.valueOf())

  // 4.åˆ¤æ–­å¦‚æœæ˜¯Symbolçš„value, é‚£ä¹ˆåˆ›å»ºä¸€ä¸ªæ–°çš„Symbol
  if (is.Symbol(value)) return Symbol(value.description)

  // 5.åˆ¤æ–­æ˜¯å¦æ˜¯Setç±»å‹ è¿›è¡Œæ·±æ‹·è´
  if (is.Set(value)) {
    // 5.1 æµ…æ‹·è´ ç›´æ¥è¿›è¡Œè§£æ„å³å¯
    // return new Set([...value])

    // 5.2 æ·±æ‹·è´
    const newSet = new Set()
    for (const item of value) newSet.add(deepClone(item), weakMap)
    return newSet
  }

  // 6.åˆ¤æ–­æ˜¯å¦æ˜¯Mapç±»å‹
  if (is.Map(value)) {
    // 6.1 æµ…æ‹·è´ ç›´æ¥è¿›è¡Œè§£æ„å³å¯
    // return new Map([...value])

    // 6.2 æ·±æ‹·è´
    const newMap = new Map()
    for (const item of value)
      newMap.set(deepClone(item[0], weakMap), deepClone(item[1], weakMap))
    return newMap
  }

  // 9.åˆ¤æ–­weakMapæ˜¯å¦æœ‰å€¼ æœ‰å€¼çš„æƒ…å†µä¸‹å°±ç›´æ¥å°†å€¼è¿”å›å°±å¯ä»¥
  if (weakMap.has(value)) return weakMap.get(value)

  // 11.2 åˆ¤æ–­æ•°ç»„
  if (is.Array(value)) {
    const newArr = []
    for (const item in value) newArr[item] = deepClone(value[item], weakMap)
    return newArr
  }

  // 1.å¦‚æœä¸æ˜¯å¯¹è±¡ç±»å‹åˆ™ç›´æ¥å°†å½“å‰å€¼è¿”å›
  if (!is.Object(value)) return value

  // 7.åˆ¤æ–­ä¼ å…¥çš„å¯¹è±¡æ˜¯æ•°ç»„, è¿˜æ˜¯å¯¹è±¡
  const newObj = is.Array(value) ? [] : {}

  // 10.å½“weakMapæ²¡æœ‰å€¼æ—¶ï¼Œå°†originValueä½œä¸ºkey, newObjä½œä¸ºvalue
  weakMap.set(value, newObj)

  for (const key in value) {
    // 11.1 åˆ¤æ–­æ•°ç»„
    if (is.Array(value[key])) deepClone(value[key], weakMap)

    weakMap.set(value, newObj)
    // 8 è¿›è¡Œé€’å½’è°ƒç”¨
    newObj[key] = deepClone(value[key], weakMap)
  }

  // 4.1 å¯¹Symbolä½œä¸ºkeyè¿›è¡Œç‰¹æ®Šçš„å¤„ç† æ‹¿åˆ°å¯¹è±¡ä¸Šé¢çš„æ‰€æœ‰Symbol keyï¼Œä»¥æ•°ç»„å½¢å¼è¿”å›
  const symbolKeys = Object.getOwnPropertySymbols(value)
  for (const sKey of symbolKeys) {
    // 4.2 è¿™é‡Œæ²¡æœ‰å¿…è¦åˆ›å»ºä¸€ä¸ªæ–°çš„Symbol
    // const newSKey = Symbol(sKey.description)

    // 4.3 ç›´æ¥å°†åŸæ¥çš„Symbol key æ‹·è´åˆ°æ–°å¯¹è±¡ä¸Šå°±å¯ä»¥äº†
    newObj[sKey] = deepClone(value[sKey], weakMap)
  }

  return newObj
}
```

::: tip
ä¸‹é¢ä¸¤ç§å°±æ˜¯åº“ä¸­çš„å‡½æ•°é€’å½’æ‹·è´ï¼Œå®ç°æ–¹æ³•åŠ£æœ‰ä¸åŒï¼Œæ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„
:::

### `JQuery.extend()`

```js
import $ from 'jquery'

const obj2 = $.extend(true, {}, obj1)
```

### `lodash.cloneDeep`

```js
import { cloneDeep } from 'lodash-es'

const obj2 = cloneDeep(obj1)
```
